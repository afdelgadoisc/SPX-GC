<!DOCTYPE html>
<html lang="en">

<head>
    <title>3D Countdown Clock</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link type="text/css" rel="stylesheet" href="main.css">
    <script>
        window.SPXGCTemplateDefinition = {
            "description": "Top left with icon",
            "playserver": "OVERLAY",
            "playchannel": "1",
            "playlayer": "7",
            "webplayout": "7",
            "out": "manual",
            "uicolor": "2",
            "dataformat": "json",
            "DataFields": [
                {
                    "ftype": "instruction",
                    "value": "A example demo template definition. Learn what it does and make use of it's capabilities."
                },
                {
                    "field": "targetTime",
                    "ftype": "textfield",
                    "title": "Target Time eg: YYYY-MM-DDThh:mm:ss{[+-]hhmm} or hh:mm:ss",
                    "value": "08:00:00"
                },
                {
                    "field": "renderSkew",
                    "ftype": "textfield",
                    "title": "Time skew of CasparCG rendering in milliseconds",
                    "value": "650"
                },
                {
                    "field": "cameraHeight",
                    "ftype": "number",
                    "title": "Camera height",
                    "value": "280"
                },
                {
                    "field": "cameraAngle",
                    "ftype": "number",
                    "title": "Camera angle",
                    "value": "280"
                },
                {
                    "field": "sceneColor",
                    "ftype": "textfield",
                    "title": "HEX RGB value of color",
                    "value": "0xFFFFFF"
                },
            ]
        };
    </script>
</head>

<script>
    let data = {};
    let isPlaying = false;
    let isStopping = false;
    let initialize = false;
    let isUpdated = false;
    let isCasparCG = false;
    let renderSkew = 1300;
    let targetDate = new Date('2030-09-11T23:54:00');
    let container;
    let rendersPerMS = 125;
    let cameraHeight = 280;
    let cameraAngle = 280;
    let sceneColor = 0xFFFFFF;

    function alwaysFullDate(target) {
        if (target.includes('T')) {
            return target;
        }

        const n = new Date();

        return `${n.getFullYear()}-${((n.getMonth() + 1) < 10 ? '0' : '') + (n.getMonth() + 1)}-${(n.getDate() < 10 ? '0' : '') + n.getDate()}T${target}${target.includes('-') ? '' : n.toTimeString().replace(/([0-9]{2}:?){3} ...([+-][0-9]{4}) .*/, '$2')}`;
    }

    function postLoad() {
        //log('postLoad starting');
        //log('container ' + JSON.stringify(!container));

        if (!container) {
            container = document.createElement('div');
            container.id = 'L4';
            container.style = "background-color: rgba(#000000, 0.0); color: rbga(#000000, 0.0);";
            document.body.appendChild(container);
            initialize = true;
        }
        //log('postLoad done');
    }

    function play() {
        log('play()ing');
        isPlaying = true;
        isStopping = false;
    }

    function stop() {
        log('stop()ing');
        isStopping = true;
    }

    function next() {
        log('next()');
    }

    function update(_data) {
        data = typeof _data === 'string' ? JSON.parse(_data) : _data;
        log('update()ing ' + typeof data + "  " + JSON.stringify(data));


        renderSkew = data.renderSkew ? parseInt(data.renderSkew) : 1300;

        if (data.targetTime) {
            targetDate = new Date(alwaysFullDate(data.targetTime));
        }


        if (data.cameraHeight) {
            cameraHeight = parseInt(data.cameraHeight);
        }

        if (data.cameraAngle) {
            cameraAngle = parseInt(data.cameraAngle);
        }

        if (data.sceneColor) {
            sceneColor = typeof data.sceneColor === 'string' ? parseInt(data.sceneColor) : data.sceneColor;
        }

        // Delay initialization until sometime later
        window.setTimeout(() => {
            postLoad();
            isUpdated = true;
        }, 200);
    }

    // function remove() {
    //   log('remove()');
    // }

    function action1() {
        log('action1() ' + JSON.stringify(arguments));
    }


    window.onerror = function (msg) {
        log('error: ' + msg);
    }

    function log(s, d) {
        console.log(s, d);
    }

    log(window.location)
    log('Chrome: ' + window.navigator.userAgent.match(/Chrome\/([^ ]+)/)[1]);

    isCasparCG = ('71.0.3578.98' === window.navigator.userAgent.match(/Chrome\/([^ ]+)/)[1]);

    log('is caspar cg: ' + isCasparCG);

    //log('pre-body script done!');
</script>

<!--
<body style="background-color: rgba(#000000, 0.0); color: rgba(#000000, 0.0)" onload="postLoad();">
<body style="background-image: url('greyBackground2.png');background-repeat: no-repeat;background-size: 100%;" onload="postLoad();">
-->
<body style="background-image: url('greyBackground4.png');background-repeat: no-repeat;background-size: 100%;" onload="postLoad();">

        <script src="dist/main.js"></script>
</body>


</html>
